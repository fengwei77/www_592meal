# 綠界金流回饋設定說明

## 問題描述
交易完成後，畫面只顯示 "1|OK"，沒有顯示結果頁面，並且用戶會被登出。

## 解決方案

### 1. 綠界金流回饋設定
在綠界金流後台設定以下回饋參數：

#### 回饋網址設定：
- **付款完成通知網址**: `https://cms.592meal.online/ecpay/payment.info`
- **Client 端回傳網址**: `https://cms.592meal.online/ecpay/payment-result`

#### 重要設定：
- 確保 **付款完成通知網址** 指向我們的 API 端點
- **Client 端回傳網址** 指向顯示結果給用戶的頁面
- 取消勾選「重新導向」選項（如果存在）

### 2. 流程說明
1. **用戶付款完成** → 綠界金流呼叫我們的 API
2. **API 處理** → 驗證資料並更新訂單狀態
3. **回饋 "1|OK"** → 告訴綠界金流成功接收
4. **用戶導向** → 綠界金流將用戶導向到結果頁面
5. **結果頁面** → 顯示付款結果，包含 592Meal 品牌

### 3. 技術實作
- **無 CSRF 保護**: 回饋路由移除了 CSRF 中間件
- **Session 保護**: 使用 session 傳遞付款結果
- **獨立頁面**: 建立了專屬的付款結果頁面
- **自動關閉**: 5秒後自動關閉彈出視窗

### 4. 新增功能
- ✅ 592Meal 品牌標題
- ✅ 付款狀態圖示（成功/失敗）
- ✅ 訂單詳細資訊（編號、金額、日期）
- ✅ 關閉視窗按鈕
- ✅ 響應式設計
- ✅ 自動關閉功能（5秒）
- ✅ 交易時間顯示

### 5. 解決登出問題
- 移除了可能干擾 session 的程式碼
- 確保金流回饋路由使用正確的中間件配置
- 禁用了 CSRF 檢查（因為來自外部系統）

## 測試步驟
1. 完成一次測試訂單付款
2. 檢查是否正確導向到結果頁面
3. 確認用戶沒有被登出
4. 驗證訂單狀態已正確更新

## 緊急聯絡
如果仍有問題，請聯繫開發團隊：
- 電話：系統管理員
- Email: support@592meal.com