# 安全設定系統 - 手動測試指南

## 📋 測試前準備

### 1. 環境設定
```bash
# 確保資料庫已遷移
php artisan migrate:fresh --seed

# 清除所有快取
php artisan optimize:clear
```

### 2. 建立測試帳號
使用 `security:manage` 命令或資料庫 Seeder 建立以下測試帳號：

**Super Admin 帳號：**
- Email: `admin@test.com`
- Password: `password`
- 角色: `super_admin`

**店家帳號 1（年輕店家）：**
- Email: `owner1@test.com`
- Password: `password`
- 角色: `store_owner`

**店家帳號 2（年長店家）：**
- Email: `owner2@test.com`
- Password: `password`
- 角色: `store_owner`

### 3. 準備工具
- Google Authenticator App（測試 2FA 功能）
- 不同 IP 環境（VPN 或代理伺服器，測試 IP 白名單）

---

## 🧪 測試案例

### 測試組 1：權限與訪問控制

#### 測試 1.1：Super Admin 訪問用戶管理
**步驟：**
1. 使用 Super Admin 帳號登入
2. 訪問 `/admin/users`

**預期結果：**
- ✅ 可以成功訪問用戶管理頁面
- ✅ 可以看到所有店家列表
- ✅ 可以看到「建立」、「編輯」、「刪除」按鈕

#### 測試 1.2：店家無法訪問用戶管理
**步驟：**
1. 使用店家帳號登入
2. 嘗試訪問 `/admin/users`

**預期結果：**
- ✅ 顯示 403 禁止訪問錯誤
- ✅ 或者在導航選單中看不到「店家管理」選項

#### 測試 1.3：所有用戶都可訪問安全設定
**步驟：**
1. 使用任何已登入帳號
2. 訪問 `/admin/security-settings`

**預期結果：**
- ✅ Super Admin 可以訪問
- ✅ 店家可以訪問
- ✅ 可以看到「安全設定」頁面

#### 測試 1.4：未登入無法訪問
**步驟：**
1. 登出所有帳號
2. 直接訪問 `/admin/security-settings`

**預期結果：**
- ✅ 自動重導向到登入頁面 `/admin/login`

---

### 測試組 2：IP 白名單功能（Super Admin 端）

#### 測試 2.1：為店家啟用 IP 白名單
**步驟：**
1. 以 Super Admin 登入
2. 進入 `/admin/users`
3. 點擊編輯店家帳號 1
4. 在「安全設定」區塊中：
   - 啟用「啟用 IP 白名單」開關
   - 輸入 IP：`127.0.0.1`（本機測試）
   - 點擊「儲存」

**預期結果：**
- ✅ 設定成功儲存
- ✅ 顯示成功通知
- ✅ IP 白名單狀態顯示為已啟用

#### 測試 2.2：為店家停用 IP 白名單
**步驟：**
1. 以 Super Admin 登入
2. 編輯店家帳號 2
3. 關閉「啟用 IP 白名單」開關
4. 點擊「儲存」

**預期結果：**
- ✅ 設定成功儲存
- ✅ IP 白名單欄位變為隱藏
- ✅ IP 白名單狀態顯示為未啟用

#### 測試 2.3：批量管理 IP
**步驟：**
1. 以 Super Admin 登入
2. 編輯店家帳號
3. 啟用 IP 白名單
4. 輸入多個 IP（按 Enter 分隔）：
   - `127.0.0.1`
   - `192.168.1.100`
   - `10.0.0.1`

**預期結果：**
- ✅ 所有 IP 都正確儲存
- ✅ 每個 IP 顯示為獨立的標籤
- ✅ 可以點擊 ×️ 移除個別 IP

---

### 測試組 3：IP 白名單功能（店家端）

#### 測試 3.1：管理員啟用時店家可以修改
**步驟：**
1. Super Admin 為店家帳號 1 啟用 IP 白名單
2. 登出，以店家帳號 1 登入
3. 訪問 `/admin/security-settings`
4. 在 IP 白名單區塊中添加新的 IP

**預期結果：**
- ✅ 顯示「狀態：✅ 已啟用」
- ✅ 顯示「您當前的 IP：xxx.xxx.xxx.xxx」
- ✅ 可以編輯 IP 白名單
- ✅ 點擊「儲存設定」後成功更新

#### 測試 3.2：管理員停用時店家無法修改
**步驟：**
1. Super Admin 為店家帳號 2 停用 IP 白名單
2. 以店家帳號 2 登入
3. 訪問 `/admin/security-settings`

**預期結果：**
- ✅ 顯示「狀態：❌ 未啟用 (管理員已停用此功能)」
- ✅ 顯示「⚠️ 管理員已停用 IP 白名單功能」
- ✅ 看不到 IP 輸入欄位
- ✅ 無法編輯 IP

---

### 測試組 4：IP 白名單驗證（中介層）

#### 測試 4.1：允許白名單內的 IP
**步驟：**
1. Super Admin 為店家帳號 1 啟用 IP 白名單
2. 添加當前 IP 到白名單（使用安全設定頁面顯示的 IP）
3. 登出並重新以店家帳號 1 登入
4. 訪問任何管理員頁面

**預期結果：**
- ✅ 成功登入
- ✅ 可以正常瀏覽所有頁面
- ✅ 沒有被登出

#### 測試 4.2：阻擋白名單外的 IP
**步驟：**
1. Super Admin 為店家帳號 1 啟用 IP 白名單
2. 添加 IP：`192.168.1.100`（非當前 IP）
3. 登出並重新以店家帳號 1 登入
4. 嘗試訪問管理員頁面

**預期結果：**
- ✅ 登入後立即被登出
- ✅ 顯示錯誤：「您的 IP 位址不在允許的白名單內」（403 錯誤）
- ✅ Session 被清除

**注意：** 需要使用 VPN 或代理更改 IP 來測試此功能

#### 測試 4.3：停用後所有 IP 都允許
**步驟：**
1. Super Admin 為店家帳號停用 IP 白名單
2. 從任何 IP 登入

**預期結果：**
- ✅ 所有 IP 都可以成功登入
- ✅ 不會被中介層阻擋

---

### 測試組 5：2FA 功能（Super Admin 端）

#### 測試 5.1：為店家啟用 2FA
**步驟：**
1. 以 Super Admin 登入
2. 編輯店家帳號 1
3. 啟用「啟用 2FA (雙因素認證)」開關
4. 點擊「儲存」

**預期結果：**
- ✅ 設定成功儲存
- ✅ 顯示 2FA 狀態：「❌ 未設定」
- ✅ 提示用戶需要到安全設定頁面完成設定

#### 測試 5.2：為店家停用 2FA
**步驟：**
1. 以 Super Admin 登入
2. 編輯店家帳號 2
3. 關閉「啟用 2FA」開關
4. 點擊「儲存」

**預期結果：**
- ✅ 設定成功儲存
- ✅ 2FA 狀態欄位隱藏

#### 測試 5.3：查看 2FA 設定狀態
**步驟：**
1. 以 Super Admin 登入
2. 在用戶列表查看 2FA 欄位

**預期結果：**
- ✅ 未啟用顯示 ❌
- ✅ 已啟用顯示 ✅
- ✅ 可以按 2FA 狀態篩選

---

### 測試組 6：2FA 功能（店家端 - 設定）

#### 測試 6.1：管理員啟用時可以設定 2FA
**步驟：**
1. Super Admin 為店家帳號 1 啟用 2FA
2. 以店家帳號 1 登入
3. 訪問 `/admin/security-settings`
4. 查看「雙因素認證 (2FA)」區塊

**預期結果：**
- ✅ 顯示「狀態：📱 可以設定」
- ✅ 顯示 QR Code
- ✅ 顯示「設定步驟」說明
- ✅ 顯示手動輸入密鑰

#### 測試 6.2：使用 Google Authenticator 掃描 QR Code
**步驟：**
1. 開啟 Google Authenticator App
2. 點擊「+」新增帳號
3. 選擇「掃描 QR Code」
4. 掃描安全設定頁面的 QR Code

**預期結果：**
- ✅ App 中顯示帳號名稱（應用程式名稱）
- ✅ App 中顯示用戶 email
- ✅ 開始顯示 6 位數驗證碼
- ✅ 驗證碼每 30 秒更新

#### 測試 6.3：手動輸入密鑰
**步驟：**
1. 複製安全設定頁面顯示的密鑰
2. 在 Google Authenticator App 選擇「輸入設定金鑰」
3. 貼上密鑰

**預期結果：**
- ✅ 與掃描 QR Code 結果相同
- ✅ 生成相同的驗證碼

#### 測試 6.4：管理員停用時無法設定
**步驟：**
1. Super Admin 為店家帳號 2 停用 2FA
2. 以店家帳號 2 登入
3. 訪問 `/admin/security-settings`

**預期結果：**
- ✅ 顯示「狀態：❌ 未啟用 (管理員已停用此功能)」
- ✅ 顯示「⚠️ 管理員已停用 2FA 功能」
- ✅ 看不到 QR Code
- ✅ 無法設定 2FA

---

### 測試組 7：CLI 命令測試

#### 測試 7.1：查看所有用戶
**步驟：**
```bash
php artisan security:manage list
```

**預期結果：**
- ✅ 顯示所有用戶列表
- ✅ 顯示每個用戶的 IP 白名單狀態
- ✅ 顯示每個用戶的 2FA 狀態
- ✅ 顯示用戶角色

#### 測試 7.2：使用命令啟用 IP 白名單
**步驟：**
```bash
php artisan security:manage enable-ip --user=owner1@test.com
# 輸入 IP: 127.0.0.1,192.168.1.100
```

**預期結果：**
- ✅ 顯示成功訊息
- ✅ 在資料庫中正確儲存
- ✅ 使用 `list` 命令可以看到更新

#### 測試 7.3：使用命令停用 IP 白名單
**步驟：**
```bash
php artisan security:manage disable-ip --user=owner1@test.com
```

**預期結果：**
- ✅ 顯示成功訊息
- ✅ IP 白名單被停用

#### 測試 7.4：使用命令啟用 2FA
**步驟：**
```bash
php artisan security:manage enable-2fa --user=owner1@test.com
```

**預期結果：**
- ✅ 顯示成功訊息
- ✅ 顯示提示：用戶需要到安全設定頁面掃描 QR Code

#### 測試 7.5：使用命令停用 2FA
**步驟：**
```bash
php artisan security:manage disable-2fa --user=owner1@test.com
```

**預期結果：**
- ✅ 顯示成功訊息
- ✅ 2FA 設定被清除
- ✅ Secret 和恢復碼被刪除

---

## 🔍 進階測試案例

### 測試 8.1：同時啟用 IP 白名單和 2FA
**步驟：**
1. Super Admin 為店家同時啟用 IP 白名單和 2FA
2. 店家登入並完成設定

**預期結果：**
- ✅ 兩個功能可以同時運作
- ✅ 不會互相衝突

### 測試 8.2：修改 IP 白名單不會登出當前用戶
**步驟：**
1. 店家登入後修改 IP 白名單
2. 保持在同一個 Session

**預期結果：**
- ✅ 不會被立即登出
- ✅ 下次登入時才會驗證新的 IP 白名單

### 測試 8.3：資料庫直接修改驗證
**步驟：**
1. 使用資料庫工具直接修改用戶的 IP 白名單
2. 用戶嘗試登入

**預期結果：**
- ✅ 中介層正確讀取資料庫的值
- ✅ 驗證邏輯正確運作

---

## 📊 測試記錄表

| 測試編號 | 測試項目 | 執行日期 | 測試者 | 結果 | 備註 |
|---------|---------|---------|--------|------|------|
| 1.1 | Super Admin 訪問用戶管理 | | | ☐ Pass ☐ Fail | |
| 1.2 | 店家無法訪問用戶管理 | | | ☐ Pass ☐ Fail | |
| 1.3 | 所有用戶都可訪問安全設定 | | | ☐ Pass ☐ Fail | |
| 1.4 | 未登入無法訪問 | | | ☐ Pass ☐ Fail | |
| 2.1 | 為店家啟用 IP 白名單 | | | ☐ Pass ☐ Fail | |
| 2.2 | 為店家停用 IP 白名單 | | | ☐ Pass ☐ Fail | |
| 2.3 | 批量管理 IP | | | ☐ Pass ☐ Fail | |
| 3.1 | 管理員啟用時店家可以修改 | | | ☐ Pass ☐ Fail | |
| 3.2 | 管理員停用時店家無法修改 | | | ☐ Pass ☐ Fail | |
| 4.1 | 允許白名單內的 IP | | | ☐ Pass ☐ Fail | |
| 4.2 | 阻擋白名單外的 IP | | | ☐ Pass ☐ Fail | |
| 4.3 | 停用後所有 IP 都允許 | | | ☐ Pass ☐ Fail | |
| 5.1 | 為店家啟用 2FA | | | ☐ Pass ☐ Fail | |
| 5.2 | 為店家停用 2FA | | | ☐ Pass ☐ Fail | |
| 5.3 | 查看 2FA 設定狀態 | | | ☐ Pass ☐ Fail | |
| 6.1 | 管理員啟用時可以設定 2FA | | | ☐ Pass ☐ Fail | |
| 6.2 | 使用 Google Authenticator 掃描 | | | ☐ Pass ☐ Fail | |
| 6.3 | 手動輸入密鑰 | | | ☐ Pass ☐ Fail | |
| 6.4 | 管理員停用時無法設定 | | | ☐ Pass ☐ Fail | |
| 7.1 | 查看所有用戶 | | | ☐ Pass ☐ Fail | |
| 7.2 | 使用命令啟用 IP 白名單 | | | ☐ Pass ☐ Fail | |
| 7.3 | 使用命令停用 IP 白名單 | | | ☐ Pass ☐ Fail | |
| 7.4 | 使用命令啟用 2FA | | | ☐ Pass ☐ Fail | |
| 7.5 | 使用命令停用 2FA | | | ☐ Pass ☐ Fail | |
| 8.1 | 同時啟用 IP 白名單和 2FA | | | ☐ Pass ☐ Fail | |
| 8.2 | 修改 IP 不登出當前用戶 | | | ☐ Pass ☐ Fail | |
| 8.3 | 資料庫直接修改驗證 | | | ☐ Pass ☐ Fail | |

---

## 🐛 已知問題追蹤

| 問題編號 | 描述 | 嚴重程度 | 狀態 | 發現日期 | 修復日期 |
|---------|------|---------|------|---------|---------|
| | | | | | |

---

## 📝 測試總結範本

```
測試日期：________
測試者：________
測試環境：________

通過測試：__ / 27
失敗測試：__ / 27
跳過測試：__ / 27

主要發現：
1.
2.
3.

建議改進：
1.
2.
3.

簽名：________
```
